{{define "layouts/header.gohtml"}}
<header class="flex items-center justify-between h-14 px-4 bg-base-200/50 border-b border-base-content/[0.03]">
    <button onclick="window.sidebar.openMobile()"
        class="p-2 rounded-md text-base-content/60 hover:text-base-content hover:bg-base-content/5 transition-colors md:hidden">
        <i data-lucide="menu" class="w-5 h-5" stroke-width="1.5"></i>
    </button>

    <h1 class="text-sm font-medium text-base-content/80 md:hidden">{{.Title}}</h1>
    <div class="hidden md:block"></div>

    <div class="flex items-center gap-3">
        <div id="wsStatusIndicator" class="flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-base-content/[0.02]">
            <span id="wsStatusDot" class="status status-neutral"></span>
            <span id="wsStatusText" class="text-xs text-base-content/50 hidden sm:inline">Connecting...</span>
        </div>

        <button id="pipToggleBtn" class="btn btn-primary btn-sm" disabled style="display:none;">
            <i id="pipIcon" data-lucide="picture-in-picture-2" class="w-4 h-4"></i>
            <span id="pipText" class="hidden sm:inline">PiP Mode</span>
        </button>
    </div>
</header>

<script>
(function() {
    const dot = document.getElementById('wsStatusDot');
    const text = document.getElementById('wsStatusText');
    const indicator = document.getElementById('wsStatusIndicator');
    const pipBtn = document.getElementById('pipToggleBtn');
    const pipIcon = document.getElementById('pipIcon');
    const pipText = document.getElementById('pipText');

    function isOnRadarPage() {
        const pageContent = document.getElementById('page-content');
        return pageContent?.dataset?.page === 'radar';
    }

    function updateVisibility() {
        const onRadar = isOnRadarPage();

        // WS indicator
        if (indicator) {
            indicator.style.display = onRadar ? 'flex' : 'none';
            if (onRadar) {
                updateIndicator(window.wsConnectionStatus || 'disconnected');
            }
        }

        // PiP button
        if (pipBtn) {
            const pipSupported = document.pictureInPictureEnabled === true;
            pipBtn.style.display = (onRadar && pipSupported) ? 'flex' : 'none';
            pipBtn.disabled = !onRadar || !window.pipManager;
        }
    }

    function updateIndicator(status) {
        if (!dot || !text) return;

        dot.classList.remove('status-success', 'status-error', 'status-warning', 'status-neutral', 'animate-pulse');
        text.classList.remove('text-base-content/60', 'text-base-content/80', 'text-error', 'text-warning');

        switch(status) {
            case 'connected':
                dot.classList.add('status-success', 'animate-pulse');
                text.textContent = 'Connected';
                text.classList.add('text-base-content/80');
                break;
            case 'disconnected':
                dot.classList.add('status-error');
                text.textContent = 'Disconnected';
                text.classList.add('text-error');
                break;
            case 'connecting':
                dot.classList.add('status-warning', 'animate-pulse');
                text.textContent = 'Connecting...';
                text.classList.add('text-warning');
                break;
            default:
                dot.classList.add('status-neutral');
                text.textContent = 'Disconnected';
                text.classList.add('text-base-content/60');
        }
    }

    function updatePipButton(isActive) {
        if (!pipBtn || !pipIcon || !pipText) return;

        if (isActive) {
            pipBtn.classList.remove('btn-primary');
            pipBtn.classList.add('btn-secondary');
            pipIcon.setAttribute('data-lucide', 'picture-in-picture');
            pipText.textContent = 'Exit PiP';
        } else {
            pipBtn.classList.remove('btn-secondary');
            pipBtn.classList.add('btn-primary');
            pipIcon.setAttribute('data-lucide', 'picture-in-picture-2');
            pipText.textContent = 'PiP Mode';
        }
        // Re-render lucide icon
        if (window.lucide) window.lucide.createIcons();
    }

    // PiP button click handler
    if (pipBtn) {
        pipBtn.addEventListener('click', async () => {
            if (window.pipManager) {
                const isActive = await window.pipManager.toggle();
                updatePipButton(isActive);
            }
        });
    }

    // Listen to PiP status changes (e.g., when user closes PiP window)
    document.addEventListener('pipStatusChange', (e) => {
        updatePipButton(e.detail.isActive);
    });

    // Listen to WS status changes
    document.addEventListener('wsStatusChange', (e) => {
        if (isOnRadarPage()) updateIndicator(e.detail.status);
    });

    // Listen to PiP manager ready
    document.addEventListener('pipManagerReady', () => {
        if (pipBtn && isOnRadarPage()) {
            pipBtn.disabled = false;
        }
    });

    // Listen to HTMX page changes
    document.body.addEventListener('htmx:afterSettle', (e) => {
        if (e.detail.target?.id === 'page-content') {
            updateVisibility();
        }
    });

    // Initial visibility check (wait for DOM since header renders before #page-content)
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateVisibility);
    } else {
        updateVisibility();
    }
})();
</script>
{{end}}
