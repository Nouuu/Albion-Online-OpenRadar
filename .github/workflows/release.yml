name: Release

on:
  push:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., 2.2.0)"
        required: true
        type: string

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

env:
  VERSION: ${{ github.event.inputs.tag || github.ref_name }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Build Linux binary via Docker (CGO + libpcap)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      # â”€â”€â”€ Prepare assets (same as .goreleaser.yml before.hooks) â”€â”€â”€
      - name: Update AO data
        run: npx tsx tools/update-ao-data.ts --replace-existing

      - name: Build CSS
        run: npm run css

      - name: Copy vendors
        run: npm run vendors

      - name: Compress game data
        run: npx tsx tools/compress-game-data.ts web/ao-bin-dumps --delete-originals

      # â”€â”€â”€ Docker build with cache â”€â”€â”€
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Linux binary
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.build
          outputs: type=local,dest=dist-build
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ env.VERSION }}
            BUILD_TIME=${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}

      - name: Rename binary
        run: mv dist-build/OpenRadar-linux dist-build/OpenRadar-linux-amd64

      - name: Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary
          path: dist-build/OpenRadar-linux-amd64
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Build Windows binary natively (CGO + Npcap SDK)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: true

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      # â”€â”€â”€ Prepare assets â”€â”€â”€
      - name: Update AO data
        run: npx tsx tools/update-ao-data.ts --replace-existing

      - name: Build CSS
        run: npm run css

      - name: Copy vendors
        run: npm run vendors

      - name: Compress game data
        run: npx tsx tools/compress-game-data.ts web/ao-bin-dumps --delete-originals

      - run: go mod tidy

      # â”€â”€â”€ Windows resources (icon + version info) â”€â”€â”€
      - name: Install goversioninfo
        run: go install github.com/josephspurrier/goversioninfo/cmd/goversioninfo@latest

      - name: Generate version info
        shell: pwsh
        run: |
          $version = "${{ env.VERSION }}"
          $parts = $version -split '[.\-]'
          $major = if ($parts[0] -match '^\d+$') { [int]$parts[0] } else { 0 }
          $minor = if ($parts.Length -gt 1 -and $parts[1] -match '^\d+$') { [int]$parts[1] } else { 0 }
          $patch = if ($parts.Length -gt 2 -and $parts[2] -match '^\d+$') { [int]$parts[2] } else { 0 }

          $json = @{
            FixedFileInfo = @{
              FileVersion = @{ Major = $major; Minor = $minor; Patch = $patch; Build = 0 }
              ProductVersion = @{ Major = $major; Minor = $minor; Patch = $patch; Build = 0 }
            }
            StringFileInfo = @{
              FileDescription = "OpenRadar - Albion Online Radar"
              FileVersion = $version
              ProductName = "OpenRadar"
              ProductVersion = $version
              LegalCopyright = "MIT License"
            }
            IconPath = "../../web/images/favicon.ico"
          } | ConvertTo-Json -Depth 10

          $json | Out-File -FilePath cmd/radar/versioninfo.json -Encoding UTF8

      - name: Generate Windows resources
        run: goversioninfo -64
        working-directory: cmd/radar

      # â”€â”€â”€ Build â”€â”€â”€
      - name: Build Windows binary
        shell: pwsh
        run: |
          $env:CGO_ENABLED = "1"
          $buildTime = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
          go build -ldflags="-s -w -X main.Version=${{ env.VERSION }} -X main.BuildTime=$buildTime" -o dist-build/OpenRadar-windows-amd64.exe ./cmd/radar

      - name: Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary
          path: dist-build/OpenRadar-windows-amd64.exe
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Assemble release artifacts and create GitHub Release (draft)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      # â”€â”€â”€ Download build artifacts â”€â”€â”€
      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: linux-binary
          path: dist

      - name: Download Windows binary
        uses: actions/download-artifact@v4
        with:
          name: windows-binary
          path: dist

      # â”€â”€â”€ Generate READMEs â”€â”€â”€
      - name: Generate READMEs
        run: npx tsx tools/generate-readmes.ts --output-dir=dist --version=${{ env.VERSION }}

      # â”€â”€â”€ Generate checksums â”€â”€â”€
      - name: Generate checksums
        working-directory: dist
        run: sha256sum OpenRadar-linux-amd64 OpenRadar-windows-amd64.exe README-linux.txt README-windows.txt > checksums-sha256.txt

      # â”€â”€â”€ List final artifacts â”€â”€â”€
      - name: List artifacts
        run: ls -la dist/

      # â”€â”€â”€ Generate changelog from Conventional Commits â”€â”€â”€
      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ env.VERSION }}^ 2>/dev/null || echo "")
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"

      - name: Generate release notes
        run: |
          PREV_TAG="${{ steps.prev_tag.outputs.tag }}"
          VERSION="${{ env.VERSION }}"

          if [ -z "$PREV_TAG" ]; then
            RANGE="HEAD"
            COMPARE_LINK=""
          else
            RANGE="${PREV_TAG}..HEAD"
            COMPARE_LINK="**Full Changelog**: https://github.com/Nouuu/Albion-Online-OpenRadar/compare/${PREV_TAG}...${VERSION}"
          fi

          echo "Generating changelog for range: $RANGE"

          # Get commits and categorize by Conventional Commits
          FEATURES=$(git log $RANGE --pretty=format:"- %s" --grep="^feat" 2>/dev/null | sed 's/- feat[^:]*:/- /' || true)
          FIXES=$(git log $RANGE --pretty=format:"- %s" --grep="^fix" 2>/dev/null | sed 's/- fix[^:]*:/- /' || true)
          PERF=$(git log $RANGE --pretty=format:"- %s" --grep="^perf" 2>/dev/null | sed 's/- perf[^:]*:/- /' || true)

          # Build release notes file
          cat > release-notes.md << 'HEADER'
          ## OpenRadar v${{ env.VERSION }}

          Real-time radar for Albion Online.

          HEADER

          if [ -n "$FEATURES" ]; then
            echo "### âœ¨ Features" >> release-notes.md
            echo "" >> release-notes.md
            echo "$FEATURES" >> release-notes.md
            echo "" >> release-notes.md
          fi

          if [ -n "$FIXES" ]; then
            echo "### ðŸ› Bug Fixes" >> release-notes.md
            echo "" >> release-notes.md
            echo "$FIXES" >> release-notes.md
            echo "" >> release-notes.md
          fi

          if [ -n "$PERF" ]; then
            echo "### âš¡ Performance" >> release-notes.md
            echo "" >> release-notes.md
            echo "$PERF" >> release-notes.md
            echo "" >> release-notes.md
          fi

          cat >> release-notes.md << EOF
          ---

          ### Verification

          \`\`\`bash
          sha256sum -c checksums-sha256.txt
          \`\`\`

          ### Requirements

          **Windows:** Windows 10/11 (64-bit), [Npcap 1.84+](https://npcap.com/)

          **Linux:** libpcap (\`apt install libpcap0.8\`)

          ---

          ${COMPARE_LINK}
          EOF

          echo "Generated release notes:"
          cat release-notes.md

      # â”€â”€â”€ Create GitHub Release (draft) â”€â”€â”€
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: "OpenRadar v${{ env.VERSION }}"
          draft: true
          body_path: release-notes.md
          files: |
            dist/OpenRadar-linux-amd64
            dist/OpenRadar-windows-amd64.exe
            dist/README-linux.txt
            dist/README-windows.txt
            dist/checksums-sha256.txt
