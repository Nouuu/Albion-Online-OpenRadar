# ðŸ§‘â€ðŸ’» OpenRadar Development Guide

> **Goal:** Technical reference for contributors and advanced users working on OpenRadar.

---

## 1. Architecture Overview

### 1.1 High-Level Structure

OpenRadar is a Node.js application that:

- Captures Albion Online network packets (UDP 5056) using `cap`.
- Parses Photon packets into events and requests.
- Sends parsed data to the browser via WebSocket.
- Renders a radar UI using EJS templates and client-side JavaScript.

Main components:

- `app.js` â€“ Entry point, Express server, WebSocket server, packet capture wiring.
- `scripts/classes/` â€“ Core classes: packet parser, handlers, utilities.
- `scripts/Handlers/` â€“ Domain-specific handlers (mobs, resources, players, etc.).
- `scripts/Drawings/` â€“ Rendering logic for the radar (shapes, markers, overlays).
- `scripts/Utils/` â€“ Shared helpers (logging, settings, constants, etc.).
- `views/` â€“ EJS templates for the UI.
- `server-scripts/` â€“ Server-side helpers (adapter selection, logging server, etc.).
- `work/` â€“ Python tooling and data for offline analysis (TypeIDs, dumps, etc.).

---

## 2. UI / Windowing

### 2.1 Browser-Based Overlay

The radar UI is displayed in a standard browser window (Edge/Chrome), not an Electron app.

**Implementation:**

- Separate popup window (`window.open()`).
- Custom drag bar at the top.
- Auto-hide controls after 2 seconds.
- Recommended tool for pinning on top: **DeskPins**.
  - Download: https://efotinis.neocities.org/deskpins/
  - Pin the overlay window to keep it top-most while playing.

**Browser limitations (security):**

- âš  URL bar is visible (cannot be fully hidden).
- âš  Window borders depend on the browser/OS.

### 2.2 Electron: Migration Cancelled

**Test performed:** `cap` module does not build with Electron v39.

**Reason:** Python `distutils` deprecated, `node-gyp` + Electron ABI combination too unstable.

**Decision:** **Keep current architecture** (Node pkg + standard browser) for stability and simplicity.

---

## 3. Packet Parsing & Handlers

### 3.1 Packet Flow

1. `app.js` uses `cap` to capture UDP packets on port 5056.
2. Packets are fed into `PhotonPacketParser`.
3. `PhotonPacketParser` emits `event`, `request`, and `response` objects.
4. Handlers in `scripts/Handlers/` process those events:
   - `MobsHandler`, `ResourcesHandler`, `PlayersHandler`, etc.
5. Parsed data is sent to the browser via WebSocket (port 5002).
6. Client-side handlers update the UI / radar accordingly.

### 3.2 Mobs & Harvestables (TypeIDs)

`MobsHandler` and `MobsInfo` map TypeIDs to resource types (Hide, Fiber, Wood, Ore, Rock) and tiers.

- See `docs/work/COLLECTION_GUIDE.md` for the TypeID collection strategy.
- See `docs/work/IMPROVEMENTS.md` and `docs/work/PLAYER_DETECTION_STATUS.md` for investigation history.

Static reference files generated by Python tools (under `tools/output/`):

- `harvestables-typeids.js` â€“ Static harvestable TypeIDs.
- `living-resources-enhanced.json` â€“ 225 living creatures with metadata.
- `living-resources-reference.js` â€“ JavaScript-ready reference.

The development guide embeds a summary of key conclusions:

- TypeIDs for living resources (mobs) are **server runtime identifiers**, not present as-is in client files.
- Items TypeIDs and Mobs TypeIDs live in separate namespaces; collisions exist (same numeric ID for unrelated things).

Example collision (from `docs/dev/DEV_GUIDE.md` original analysis):

```text
TypeID 358:
  items.txt â†’ QUESTITEM_EXP_TOKEN_D16_T6_EXP_HRD_KEEPER_MUSHROOM
  MobsInfo.js (network) â†’ T1 Rabbit (Hide)

TypeID 421:
  items.txt â†’ QUESTITEM_EXP_TOKEN_D7_T6_EXP_HRD_MORGANA_TORTURER
  MobsInfo.js (network) â†’ T1 Rabbit variant

Conclusion: Items and MOBs have separate TypeID namespaces.
```

**Fields inspected in `mobs.json` (73 attributes):**

- `@uniquename`, `@tier`, `@prefab`, `@faction`, `@hitpointsmax`, `@abilitypower`, ...
- **No field** like `@id`, `@typeid`, `@index` (except `@idleanimoffset=0` for idle animations).

---

## 4. Living Resources Metadata

### 4.1 Extracted Metadata

**Sources:** `mobs.json` + `randomspawnbehaviors.json` from official dumps.

**Living resources found:**

- **93 animals** (LivingSkinnable â€“ Hide)
- **46 Fiber guardians**
- **43 Wood guardians**
- **43 Ore guardians**
- **43 Rock guardians**

**Per-creature metadata structure:**

```javascript
{
  uniqueName: "MOB_RABBIT",
  tier: 1,
  prefab: "MOB_HIDE_RABBIT_01",
  hp: 20,
  faction: "RABBIT",
  enchant: 0 // inferred from "_ROADS" or "_MISTS" in uniqueName
}
```

Generated data files:

- `tools/output/living-resources-enhanced.json` â€“ 225 creatures with metadata.
- `tools/output/living-resources-reference.js` â€“ JavaScript module ready to use.

### 4.2 Proposed Improvements (Without Extra TypeIDs)

#### 4.2.1 HP-Based Validation

**Idea:** Compare detected HP with expected HP for a sanity check.

```javascript
// In MobsHandler.js
validateCreature(typeId, hp, tier) {
  const expected = this.mobsInfo.getExpectedHP(typeId, tier);
  if (expected && Math.abs(hp - expected.hp) / expected.hp > 0.2) {
    console.warn(`TypeID ${typeId}: HP ${hp} unexpected (expected ~${expected.hp})`);
    return false;
  }
  return true;
}
```

**Available HP samples:**

- T1 Rabbit: 20 HP
- T2 Fox: 515 HP
- T3 Wolf: 685 HP
- T4 Boar: 1323 HP
- T5 Bear: 1385 HP
- +175 guardians with HP values.

#### 4.2.2 Enriching `MobsInfo.js`

**Current format:**

```javascript
this.addItem(358, 1, 1, "hide");
```

**Proposed richer format:**

```javascript
this.addItemWithMetadata(358, {
  tier: 1,
  enemyType: 1,
  resourceType: "hide",
  animal: "Rabbit",           // new
  expectedHP: 20,             // new
  prefab: "MOB_HIDE_RABBIT_01", // new
  faction: "RABBIT"           // new
});
```

**Benefits:**

- Automatic HP validation.
- Better debugging (exact animal name).
- Possible filtering by faction.

#### 4.2.3 Enchantment Detection via HP

**Idea:** Use HP ratio vs base HP to estimate enchantment level.

```javascript
detectEnchantmentLevel(hp, baseTier) {
  const baseHP = this.getBaseHP(baseTier);
  const hpRatio = hp / baseHP;

  if (hpRatio >= 1.8) return 3; // .3
  if (hpRatio >= 1.5) return 2; // .2
  if (hpRatio >= 1.2) return 1; // .1
  return 0; // .0
}
```

**Field examples:**

- `MOB_WOLF` normal â†’ HP 685 â†’ .0
- `T4_MOB_CRITTER_HIDE_MISTCOUGAR` â†’ HP 962 â†’ ~1.4 ratio â†’ .1
- `T4_MOB_CRITTER_HIDE_MISTCOUGAR_VETERAN` â†’ HP 6448 â†’ .3+ (boss)

#### 4.2.4 Expected Creatures Guide (UI)

Example UI addition in `resources.ejs`:

```html
<div class="expected-creatures">
  <h4>Expected T5 Creatures</h4>
  <ul>
    <li>Bear (HP ~1385)</li>
    <li>Direwolf (HP ~1200)</li>
    <li>Terrorbird (HP ~1367)</li>
  </ul>
</div>
```

**Reference data** (`living-resources-reference.js`):

- T1: Rabbit (4 variants), Chicken
- T2: Goose, Goat, Fox (4 variants)
- T3: Fox, Boar, Wolf, Deer, Moabird
- T4: Wolf, Deer, Bear, Boar, Cougar
- T5: Bear (8 variants), Direwolf, Terrorbird
- T6: Direbear, Terrorbird
- T7: Moabird, Swamp Dragon
- T8: Mammoth, RhinocÃ©ros

#### 4.2.5 Improved Logging

**Before:**

```text
[LIVING] TypeID: 425 | Tier: 4 | Type: 1 | Enchant: 0
```

**After** (with metadata):

```text
[LIVING RESOURCE DETECTED]
TypeID: 425
Tier: T4 | Enchant: .0
HP: 1323 (expected ~1323) âœ“ MATCH
Resource: Hide
Creature: Boar (MOB_HIDE_BOAR_01)
Faction: BOAR
Validation: âœ“ CONFIRMED
```

---

## 5. Python Tools & Data Files

### 5.1 Analysis Scripts

1. `tools/parse-all-resources.py` â€“ Extract static resources âœ…
2. `tools/analyze-missing-typeids.py` â€“ Coverage analysis for `MobsInfo.js` âœ…
3. `tools/search-living-mobs.py` â€“ Exhaustive search of ID fields âœ…
4. `tools/extract-mob-metadata.py` â€“ Extract living resource metadata âœ…

### 5.2 Data Files to Keep

- `tools/output/harvestables-typeids.js` â€“ 139 static TypeIDs.
- `tools/output/living-resources-enhanced.json` â€“ 225 creatures with metadata.
- `tools/output/living-resources-reference.js` â€“ JavaScript reference module.

### 5.3 Collection Method (Unchanged)

**Only viable method:** **In-game logging**

1. Enable **"Log Living Creatures"** in Settings.
2. Open browser console (F12).
3. Kill/harvest each creature in-game.
4. Record TypeIDs from logs.
5. Update `MobsInfo.js` accordingly.

**Estimated effort:** 2â€“4 hours of gameplay to collect ~100â€“150 missing TypeIDs.

### 5.4 Current `MobsInfo.js` Status

**Total:** 197 TypeIDs collected manually.

| Resource | .0 (Base) | .1/.2/.3 (Enchanted) | Status        |
|----------|-----------|----------------------|---------------|
| Hide     | 85 IDs    | 0 IDs                | âœ“ Full base   |
| Fiber    | 39 IDs    | 0 IDs                | âœ“ Full base   |
| Ore      | 38 IDs    | 0 IDs                | âš  Partial     |
| Rock     | 35 IDs    | 0 IDs                | âš  Partial     |
| Logs     | 0 IDs     | 0 IDs                | âŒ Missing    |

**Critical missing (~50â€“60 TypeIDs):**

- Hide T4â€“T5 .1/.2/.3 (3Ã—2 tiers = 6 variants).
- Fiber T4â€“T5 .1/.2/.3 (6 variants).
- Wood guardians (T3â€“T8, all variants).
- Enchanted Ore/Rock guardians.

### 5.5 Proposed Implementation Plan

#### Phase 1: Validation (1â€“2h) â€“ OPTIONAL

- [ ] Add HP validation in `MobsHandler.js`.
- [ ] Improve logging with expected-creature hints.
- [ ] Test against existing TypeIDs.

#### Phase 2: UI Integration (2â€“3h) â€“ OPTIONAL

- [ ] Add creature guide to `resources.ejs`.
- [ ] Implement filters by animal.
- [ ] Display metadata on the radar.

#### Phase 3: Enrichment (2â€“3h) â€“ OPTIONAL

- [ ] Change `MobsInfo.js` structure to store metadata.
- [ ] Add automatic enchantment detection via HP.
- [ ] Implement advanced filtering options.

> Note: These improvements are optional; the current system is already functional for TypeID collection.

---

_End of document._
