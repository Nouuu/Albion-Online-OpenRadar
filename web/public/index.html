<!DOCTYPE html>
<html class="dark" x-data="data()" lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenRadar - Albion Online Radar</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="/scripts/styles/tooltips.css" />

    <!-- Custom Scripts -->
    <script type="module" src="/scripts/constants/LoggerConstants.js"></script>
    <script type="module" src="/scripts/LoggerClient.js"></script>
    <script type="module">
        // Global imports - expose for SPA pages
        import settingsSync from '/scripts/Utils/SettingsSync.js';
        import { CATEGORIES } from '/scripts/constants/LoggerConstants.js';
        import {
            attachCheckboxListeners,
            generateResourceGrid,
            initializeTierButtonStates,
            updateTierButtonState,
            selectAllTierEnchants,
            getResourceStorageKey
        } from '/scripts/Utils/ResourcesHelper.js';

        // Expose globally for dynamically loaded pages
        window.settingsSync = settingsSync;
        window.ResourcesHelper = {
            attachCheckboxListeners,
            generateResourceGrid,
            initializeTierButtonStates,
            updateTierButtonState,
            selectAllTierEnchants,
            getResourceStorageKey
        };

        window.logger?.info(CATEGORIES.SETTINGS, 'InitializingSettingsSync' ,'SettingsSync initialized for all pages', settingsSync);
    </script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/scripts/init-alpine-spa.js"></script>

    <!-- jQuery & SignalR -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/9.0.6/signalr.min.js" ></script>

    <style>
        [x-cloak] { display: none !important; }
        .page-loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>
  <div class="flex h-screen bg-gray-900" :class="{ 'overflow-hidden': isSideMenuOpen }">

    <!-- Desktop Sidebar -->
    <aside
      :class="{'w-64': !sidebarCollapsed || sidebarHoverExpanded, 'w-20': sidebarCollapsed && !sidebarHoverExpanded}"
      class="z-20 hidden md:block flex-shrink-0 overflow-y-auto bg-gray-800 transition-all duration-500"
      @mouseenter="onSidebarMouseEnter"
      @mouseleave="onSidebarMouseLeave"
    >
      <div class="py-4 text-gray-300">
        <!-- Header -->
        <div class="flex items-center justify-between px-6">
          <a x-show="!sidebarCollapsed || sidebarHoverExpanded" class="text-lg font-bold text-gray-200" href="#">
            OpenRadar
          </a>
          <button
            @click="toggleSidebar"
            :class="{'ml-auto': sidebarCollapsed && !sidebarHoverExpanded}"
            class="p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
            :title="sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'"
          >
            <i data-lucide="menu" class="w-6 h-6"></i>
          </button>
        </div>

        <!-- Menu Items -->
        <ul class="mt-6">
          <template x-for="item in menuItems" :key="item.path">
            <li class="relative px-6 py-3">
              <!-- Active Indicator -->
              <span x-show="currentPath === item.path || (currentPath === '/' && item.path === '/home')" class="absolute inset-y-0 left-0 w-1 bg-purple-600 rounded-tr-lg rounded-br-lg"></span>

              <a
                :href="'#' + item.path"
                @click.prevent="navigateTo(item.path)"
                :class="{
                  'text-white': currentPath === item.path || (currentPath === '/' && item.path === '/home'),
                  'text-gray-400 hover:text-gray-200': currentPath !== item.path && !(currentPath === '/' && item.path === '/home'),
                  'justify-center': sidebarCollapsed && !sidebarHoverExpanded
                }"
                class="inline-flex items-center w-full text-sm font-semibold transition-colors duration-150"
                :title="(sidebarCollapsed && !sidebarHoverExpanded) ? item.label : ''"
              >
                <i :data-lucide="item.icon" :class="{'mr-0': sidebarCollapsed && !sidebarHoverExpanded}" class="w-5 h-5 mr-3"></i>
                <span x-show="!sidebarCollapsed || sidebarHoverExpanded" x-text="item.label"></span>
              </a>
            </li>
          </template>
        </ul>
      </div>
    </aside>

    <!-- Mobile Sidebar -->
    <!-- Backdrop -->
    <div
      x-show="isSideMenuOpen"
      x-transition.opacity.duration.150ms
      @click="closeSideMenu"
      class="fixed inset-0 z-10 bg-black bg-opacity-50 md:hidden"
    ></div>

    <!-- Mobile Menu -->
    <aside
      x-show="isSideMenuOpen"
      x-transition.duration.150ms
      @click.outside="closeSideMenu"
      @keydown.escape="closeSideMenu"
      class="fixed inset-y-0 left-0 z-20 w-64 overflow-y-auto bg-gray-800 md:hidden"
    >
      <div class="py-4 text-gray-300">
        <a class="ml-6 text-lg font-bold text-gray-200" href="#">OpenRadar</a>

        <ul class="mt-6">
          <template x-for="item in menuItems" :key="item.path">
            <li class="relative px-6 py-3">
              <span x-show="currentPath === item.path || (currentPath === '/' && item.path === '/home')" class="absolute inset-y-0 left-0 w-1 bg-purple-600 rounded-tr-lg rounded-br-lg"></span>
              <a
                :href="'#' + item.path"
                @click.prevent="navigateTo(item.path); closeSideMenu()"
                :class="{'text-white': currentPath === item.path || (currentPath === '/' && item.path === '/home'), 'text-gray-400 hover:text-gray-200': currentPath !== item.path && !(currentPath === '/' && item.path === '/home')}"
                class="inline-flex items-center w-full text-sm font-semibold transition-colors"
              >
                <i :data-lucide="item.icon" class="w-5 h-5 mr-3"></i>
                <span x-text="item.label"></span>
              </a>
            </li>
          </template>
        </ul>
      </div>
    </aside>

    <!-- Main Content Area -->
    <div class="flex flex-col flex-1 w-full">
      <!-- Header -->
      <header class="z-10 py-4 bg-gray-800 shadow-md">
        <div class="container flex items-center justify-between h-full px-6 mx-auto text-purple-400">
          <!-- Mobile Menu Button -->
          <button
            @click="toggleSideMenu"
            class="p-1 -ml-1 rounded-md md:hidden focus:outline-none focus:ring-2 focus:ring-purple-500"
          >
            <i data-lucide="menu" class="w-6 h-6"></i>
          </button>

          <div class="flex-1"></div>

          <!-- Right Side Items -->
          <ul class="flex items-center space-x-6">
            <!-- Loading indicator -->
            <li x-show="isLoading" class="text-sm text-gray-400">Loading...</li>
          </ul>
        </div>
      </header>

      <!-- Main Content - Pages loaded here -->
      <main id="pageContent" class="h-full overflow-y-auto bg-gray-900" :class="{'page-loading': isLoading}">
        <!-- Content loaded dynamically -->
        <div class="container px-6 mx-auto py-4">
          <div class="text-center text-gray-400">
            <p>Loading page...</p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    document.addEventListener('alpine:initialized', () => {
      lucide.createIcons();
    });
  </script>

  <!-- Server logs sync on startup -->
  <script type="module">
    import settingsSync from '/scripts/Utils/SettingsSync.js';
    (async () => {
      try {
        const serverLogsEnabled = settingsSync.getBool("settingServerLogsEnabled");
        const response = await fetch('/api/settings/server-logs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled: serverLogsEnabled })
        });
        const result = await response.json();
        if (result.success) {
          console.log(`[Layout] Server-side logging initialized: ${serverLogsEnabled ? 'ENABLED' : 'DISABLED'}`);
        }
      } catch (error) {
        console.error('[Layout] Error initializing server logs setting:', error);
      }
    })();
  </script>
</body>
</html>
